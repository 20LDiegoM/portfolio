<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Rent A Car Site</title>
        <link rel="icon" type="image/x-icon" href="../favicon.ico" />
        <link rel="stylesheet" href="../dist/vendor.bundle.css" />
        <link rel="stylesheet" href="../dist/custom.bundle.css" />
    </head>
    <body>
        <section class="main-banner">
            <div class="container">
                <div class="row">
                    <div class="col-12 col-lg-6">
                        <a data-aos="fade-up" href="/portfolio">
                            <span class="back-home">
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M22 22L2 22" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round"></path> <path d="M2 11L6.06296 7.74968M22 11L13.8741 4.49931C12.7784 3.62279 11.2216 3.62279 10.1259 4.49931L9.34398 5.12486" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round"></path> <path d="M15.5 5.5V3.5C15.5 3.22386 15.7239 3 16 3H18.5C18.7761 3 19 3.22386 19 3.5V8.5" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round"></path> <path d="M4 22V9.5" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round"></path> <path d="M20 9.5V13.5M20 22V17.5" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round"></path> <path d="M15 22V17C15 15.5858 15 14.8787 14.5607 14.4393C14.1213 14 13.4142 14 12 14C10.5858 14 9.87868 14 9.43934 14.4393M9 22V17" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M14 9.5C14 10.6046 13.1046 11.5 12 11.5C10.8954 11.5 10 10.6046 10 9.5C10 8.39543 10.8954 7.5 12 7.5C13.1046 7.5 14 8.39543 14 9.5Z" stroke="#ffffff" stroke-width="1.5"></path></svg>
                            </span>
                        </a>
                        <h1 data-aos="fade-up" class="main-banner-title">Generate and Download a CSV of Posts</h1>
                        <p data-aos="fade-up" class="main-banner-description">This PHP script dynamically generates a CSV file. The script retrieves data about both featured images and ACF.</p>
                    </div>
                </div>
            </div>
        </section>

        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320">
            <path fill="#0F1C2E" fill-opacity="1" d="M0,128L288,192L576,224L864,160L1152,160L1440,128L1440,0L1152,0L864,0L576,0L288,0L0,0Z"></path>
        </svg>

        <section class="description-project">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        <h3 data-aos="fade-up">Key Features</h3>

                        <ul data-aos="fade-up">
                            <li><strong>Dynamic CSV Generation:</strong> Automatically creates a CSV file with columns like post ID, title, date, image URLs, and dimensions.</li>
                            <li><strong>Integration with WordPress Database:</strong> Fetches metadata for featured images and custom fields directly from the WordPress database using SQL queries.</li>
                            <li><strong>Easy to Trigger:</strong> Adding <code>?download_csv=1</code> to any page URL triggers the CSV download, making it simple to use.</li>
                            <li><strong>Data Handling:</strong> Processes metadata for both featured images and ACF fields, ensuring complete and accurate records in the CSV.</li>
                            <li><strong>Export Ready:</strong> Formats the CSV with headers and rows for easy import into spreadsheet software or other tools.</li>
                        </ul>

                        <p data-aos="fade-up">This code is especially useful for developers looking to automate data exports and maintain structured records of custom post types in WordPress.</p>

                        <pre data-aos="fade-up">
                            <code class="language-php">
                                /**
                                * Generate and download a CSV file with information about "people" posts in WordPress.
                                * This includes both the featured image (_thumbnail_id) and a custom ACF field ('people_picture').
                                * The CSV contains details like image IDs, URLs, and the original dimensions (width x height).
                                * 
                                * Usage: Add ?download_csv=1 to any page URL to trigger the CSV download.
                                */

                                if (isset($_GET['download_csv']) && $_GET['download_csv'] === '1') {
                                    global $wpdb;

                                    // Query to fetch post data, featured image, and ACF custom field
                                    $results = $wpdb->get_results("
                                        SELECT
                                            p.ID AS post_id,
                                            p.post_title,
                                            p.post_date,
                                            pm_thumbnail.meta_value AS thumbnail_id,
                                            p2.guid AS thumbnail_url,
                                            pm_thumbnail_meta.meta_value AS thumbnail_metadata,
                                            pm_acf.meta_value AS acf_picture_id,
                                            p3.guid AS acf_picture_url,
                                            pm_acf_meta.meta_value AS acf_picture_metadata
                                        FROM
                                            {$wpdb->prefix}posts p
                                        LEFT JOIN
                                            {$wpdb->prefix}postmeta pm_thumbnail ON p.ID = pm_thumbnail.post_id AND pm_thumbnail.meta_key = '_thumbnail_id'
                                        LEFT JOIN
                                            {$wpdb->prefix}posts p2 ON pm_thumbnail.meta_value = p2.ID
                                        LEFT JOIN
                                            {$wpdb->prefix}postmeta pm_thumbnail_meta ON pm_thumbnail.meta_value = pm_thumbnail_meta.post_id AND pm_thumbnail_meta.meta_key = '_wp_attachment_metadata'
                                        LEFT JOIN
                                            {$wpdb->prefix}postmeta pm_acf ON p.ID = pm_acf.post_id AND pm_acf.meta_key = 'people_picture'
                                        LEFT JOIN
                                            {$wpdb->prefix}posts p3 ON pm_acf.meta_value = p3.ID
                                        LEFT JOIN
                                            {$wpdb->prefix}postmeta pm_acf_meta ON pm_acf.meta_value = pm_acf_meta.post_id AND pm_acf_meta.meta_key = '_wp_attachment_metadata'
                                        WHERE
                                            p.post_type = 'people' AND
                                            p.post_status = 'publish'
                                    ", ARRAY_A);

                                    // Create CSV file
                                    $csv_file = fopen('php://output', 'w');

                                    // Set headers to trigger download
                                    header('Content-Type: text/csv');
                                    header('Content-Disposition: attachment; filename="People_with_Thumbnails_and_ACF_Pictures.csv"');

                                    // Write CSV headers
                                    fputcsv($csv_file, [
                                        'Post ID',
                                        'Title',
                                        'Date',
                                        'Thumbnail ID',
                                        'Thumbnail URL',
                                        'Thumbnail Size',
                                        'ACF Picture ID',
                                        'ACF Picture URL',
                                        'ACF Picture Size'
                                    ]);

                                    // Process each result and write to the CSV
                                    foreach ($results as $row) {
                                        // Process featured image metadata
                                        $thumbnail_metadata = maybe_unserialize($row['thumbnail_metadata']);
                                        $thumbnail_size = '';
                                        if (!empty($thumbnail_metadata) && isset($thumbnail_metadata['width'], $thumbnail_metadata['height'])) {
                                            $thumbnail_size = "{$thumbnail_metadata['width']}x{$thumbnail_metadata['height']}";
                                        }

                                        // Process ACF picture metadata
                                        $acf_picture_metadata = maybe_unserialize($row['acf_picture_metadata']);
                                        $acf_picture_size = '';
                                        if (!empty($acf_picture_metadata) && isset($acf_picture_metadata['width'], $acf_picture_metadata['height'])) {
                                            $acf_picture_size = "{$acf_picture_metadata['width']}x{$acf_picture_metadata['height']}";
                                        }

                                        // Write data to CSV
                                        fputcsv($csv_file, [
                                            $row['post_id'],
                                            $row['post_title'],
                                            $row['post_date'],
                                            $row['thumbnail_id'],
                                            $row['thumbnail_url'],
                                            $thumbnail_size,
                                            $row['acf_picture_id'],
                                            $row['acf_picture_url'],
                                            $acf_picture_size
                                        ], ',', '"', '\\');
                                    }

                                    // Close the CSV file and end the script
                                    fclose($csv_file);
                                    exit;
                                }
                            </code>
                        </pre>
                    </div>
                </div>
            </div>
        </section>

        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320">
            <path fill="#0F1C2E" fill-opacity="1" d="M0,128L288,192L576,224L864,160L1152,160L1440,128L1440,320L1152,320L864,320L576,320L288,320L0,320Z"></path>
        </svg>

        <section class="main-footer">
            <footer>
                <div class="container">
                    <div class="row">
                        <div class="col-12">
                            <p class="copy">© 2025 Luis Diego</p>
                        </div>
                    </div>
                </div>
            </footer>
        </section>

        <script src="../dist/vendor.bundle.js"></script>
        <script src="../dist/custom.bundle.js"></script>
    </body>
</html>
